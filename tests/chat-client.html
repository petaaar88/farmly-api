<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Client Test</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #00d9ff;
        }
        .split-container {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .user-panel {
            flex: 1;
            min-width: 0;
        }
        .user-header {
            text-align: center;
            padding: 10px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .user-panel.user1 .user-header { background: #00d9ff; color: #000; }
        .user-panel.user2 .user-header { background: #ff6b9d; color: #000; }
        .panel {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .panel h2 {
            margin-bottom: 12px;
            color: #00d9ff;
            font-size: 1rem;
        }
        .user-panel.user2 .panel h2 { color: #ff6b9d; }
        .form-group {
            margin-bottom: 12px;
        }
        label {
            display: block;
            margin-bottom: 4px;
            color: #aaa;
            font-size: 0.85rem;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0f0f23;
            color: #eee;
            font-size: 13px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #00d9ff;
        }
        .user-panel.user2 input:focus, .user-panel.user2 textarea:focus {
            border-color: #ff6b9d;
        }
        .btn-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.85;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-connect { background: #00d9ff; color: #000; }
        .btn-disconnect { background: #ff4757; color: #fff; }
        .btn-join { background: #2ed573; color: #000; }
        .btn-leave { background: #ffa502; color: #000; }
        .btn-send { background: #7c3aed; color: #fff; }
        .btn-clear { background: #555; color: #fff; }
        .user-panel.user2 .btn-connect { background: #ff6b9d; }
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
        }
        .status-dot.connected {
            background: #2ed573;
        }
        .messages {
            height: 250px;
            overflow-y: auto;
            background: #0f0f23;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
        .msg {
            padding: 6px;
            margin-bottom: 6px;
            border-radius: 4px;
            border-left: 3px solid;
        }
        .msg-info { background: #1a1a3e; border-color: #00d9ff; }
        .msg-sent { background: #1a2e1a; border-color: #2ed573; }
        .msg-received { background: #2e1a2e; border-color: #7c3aed; }
        .msg-error { background: #2e1a1a; border-color: #ff4757; }
        .msg-time {
            color: #666;
            font-size: 10px;
            margin-bottom: 3px;
        }
        .msg-content {
            word-break: break-word;
            white-space: pre-wrap;
        }
        .inline-group {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .inline-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .inline-group button {
            flex-shrink: 0;
        }
        .char-count {
            text-align: right;
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }
        .char-count.warning { color: #ffa502; }
        .char-count.limit { color: #ff4757; }
        .shared-inbox {
            max-width: 1600px;
            margin: 0 auto 20px;
        }
        .shared-inbox .panel {
            background: #1a1a3e;
        }
        .inbox-header {
            color: #fff !important;
            text-align: center;
        }
        .inbox-messages {
            height: 200px;
        }
        .inbox-msg {
            display: flex;
            gap: 10px;
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 4px;
            background: #16213e;
        }
        .inbox-msg .user-tag {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            flex-shrink: 0;
        }
        .inbox-msg.from-user1 .user-tag { background: #00d9ff; color: #000; }
        .inbox-msg.from-user2 .user-tag { background: #ff6b9d; color: #000; }
        .inbox-msg .msg-body {
            flex: 1;
            min-width: 0;
        }
        .inbox-msg .msg-text {
            word-break: break-word;
            white-space: pre-wrap;
        }
        .inbox-msg .msg-meta {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }
        @media (max-width: 900px) {
            .split-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>Socket.IO Chat Client - Two Users</h1>

    <div class="shared-inbox">
        <div class="panel">
            <h2 class="inbox-header">Shared Message Inbox</h2>
            <div class="messages inbox-messages" id="sharedInbox"></div>
            <div style="margin-top: 8px;">
                <button class="btn-clear" id="btnClearInbox">Clear Inbox</button>
            </div>
        </div>
    </div>

    <div class="split-container">
        <div class="user-panel user1">
            <div class="user-header">User 1</div>

            <div class="panel">
                <h2>Connection</h2>
                <div class="status">
                    <div class="status-dot" id="statusDot1"></div>
                    <span id="statusText1">Disconnected</span>
                </div>
                <div class="form-group">
                    <label>Server URL</label>
                    <input type="text" id="serverUrl1" value="http://localhost:3000">
                </div>
                <div class="form-group">
                    <label>JWT Token</label>
                    <input type="text" id="jwtToken1" placeholder="User 1 token">
                </div>
                <div class="btn-row">
                    <button class="btn-connect" id="btnConnect1">Connect</button>
                    <button class="btn-disconnect" id="btnDisconnect1" disabled>Disconnect</button>
                </div>
            </div>

            <div class="panel">
                <h2>Chat Room</h2>
                <div class="inline-group">
                    <div class="form-group">
                        <label>Chat ID</label>
                        <input type="number" id="chatId1" value="1" min="1">
                    </div>
                    <button class="btn-join" id="btnJoin1" disabled>Join</button>
                    <button class="btn-leave" id="btnLeave1" disabled>Leave</button>
                </div>
            </div>

            <div class="panel">
                <h2>Send Message</h2>
                <div class="form-group">
                    <textarea id="messageContent1" rows="2" placeholder="Type message..." maxlength="1000"></textarea>
                    <div class="char-count"><span id="charCount1">0</span>/1000</div>
                </div>
                <button class="btn-send" id="btnSend1" disabled>Send</button>
            </div>

            <div class="panel">
                <h2>Messages</h2>
                <div class="messages" id="messages1"></div>
                <div style="margin-top: 8px;">
                    <button class="btn-clear" id="btnClear1">Clear</button>
                </div>
            </div>
        </div>

        <div class="user-panel user2">
            <div class="user-header">User 2</div>

            <div class="panel">
                <h2>Connection</h2>
                <div class="status">
                    <div class="status-dot" id="statusDot2"></div>
                    <span id="statusText2">Disconnected</span>
                </div>
                <div class="form-group">
                    <label>Server URL</label>
                    <input type="text" id="serverUrl2" value="http://localhost:3000">
                </div>
                <div class="form-group">
                    <label>JWT Token</label>
                    <input type="text" id="jwtToken2" placeholder="User 2 token">
                </div>
                <div class="btn-row">
                    <button class="btn-connect" id="btnConnect2">Connect</button>
                    <button class="btn-disconnect" id="btnDisconnect2" disabled>Disconnect</button>
                </div>
            </div>

            <div class="panel">
                <h2>Chat Room</h2>
                <div class="inline-group">
                    <div class="form-group">
                        <label>Chat ID</label>
                        <input type="number" id="chatId2" value="1" min="1">
                    </div>
                    <button class="btn-join" id="btnJoin2" disabled>Join</button>
                    <button class="btn-leave" id="btnLeave2" disabled>Leave</button>
                </div>
            </div>

            <div class="panel">
                <h2>Send Message</h2>
                <div class="form-group">
                    <textarea id="messageContent2" rows="2" placeholder="Type message..." maxlength="1000"></textarea>
                    <div class="char-count"><span id="charCount2">0</span>/1000</div>
                </div>
                <button class="btn-send" id="btnSend2" disabled>Send</button>
            </div>

            <div class="panel">
                <h2>Messages</h2>
                <div class="messages" id="messages2"></div>
                <div style="margin-top: 8px;">
                    <button class="btn-clear" id="btnClear2">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const sharedInbox = document.getElementById('sharedInbox');
        const btnClearInbox = document.getElementById('btnClearInbox');

        function escapeHtmlGlobal(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addToInbox(userId, type, message) {
            const div = document.createElement('div');
            div.className = `inbox-msg from-user${userId}`;
            const time = new Date().toLocaleTimeString();

            let content = '';
            let meta = '';

            if (type === 'sent') {
                content = message.content;
                meta = `Sent to chat ${message.chatId}`;
            } else if (type === 'received') {
                content = message.content;
                const sender = message.sender ? message.sender.fullName : `User ${message.senderId}`;
                meta = `From: ${sender} | Chat ${message.chatId}`;
            }

            div.innerHTML = `
                <span class="user-tag">User ${userId}</span>
                <div class="msg-body">
                    <div class="msg-text">${escapeHtmlGlobal(content)}</div>
                    <div class="msg-meta">${meta} - ${time}</div>
                </div>
            `;
            sharedInbox.appendChild(div);
            sharedInbox.scrollTop = sharedInbox.scrollHeight;
        }

        btnClearInbox.addEventListener('click', () => {
            sharedInbox.innerHTML = '';
        });

        function createChatClient(userId) {
            let socket = null;
            let currentChatId = null;

            const el = (id) => document.getElementById(id + userId);

            const serverUrl = el('serverUrl');
            const jwtToken = el('jwtToken');
            const chatId = el('chatId');
            const messageContent = el('messageContent');
            const messages = el('messages');
            const statusDot = el('statusDot');
            const statusText = el('statusText');
            const btnConnect = el('btnConnect');
            const btnDisconnect = el('btnDisconnect');
            const btnJoin = el('btnJoin');
            const btnLeave = el('btnLeave');
            const btnSend = el('btnSend');
            const btnClear = el('btnClear');
            const charCount = el('charCount');

            function updateCharCount() {
                const len = messageContent.value.length;
                charCount.textContent = len;
                const parent = charCount.parentElement;
                parent.classList.remove('warning', 'limit');
                if (len >= 1000) {
                    parent.classList.add('limit');
                } else if (len >= 900) {
                    parent.classList.add('warning');
                }
            }

            function log(type, content) {
                const div = document.createElement('div');
                div.className = `msg msg-${type}`;
                const time = new Date().toLocaleTimeString();
                div.innerHTML = `<div class="msg-time">${time}</div><div class="msg-content">${escapeHtml(typeof content === 'object' ? JSON.stringify(content, null, 2) : content)}</div>`;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function setConnected(connected) {
                statusDot.classList.toggle('connected', connected);
                statusText.textContent = connected ? 'Connected' : 'Disconnected';
                btnConnect.disabled = connected;
                btnDisconnect.disabled = !connected;
                btnJoin.disabled = !connected;
                btnLeave.disabled = !connected || !currentChatId;
                btnSend.disabled = !connected;
                serverUrl.disabled = connected;
                jwtToken.disabled = connected;
            }

            btnConnect.addEventListener('click', () => {
                const url = serverUrl.value.trim();
                const token = jwtToken.value.trim();

                if (!url) {
                    log('error', 'Please enter server URL');
                    return;
                }

                log('info', `Connecting to ${url}...`);

                socket = io(url, {
                    auth: { token: token }
                });

                socket.on('connect', () => {
                    log('info', `Connected! Socket ID: ${socket.id}`);
                    setConnected(true);
                });

                socket.on('connect_error', (err) => {
                    log('error', `Connection failed: ${err.message}`);
                    setConnected(false);
                });

                socket.on('disconnect', (reason) => {
                    log('info', `Disconnected: ${reason}`);
                    setConnected(false);
                    currentChatId = null;
                });

                socket.on('new-message', (message) => {
                    log('received', `New message: ${JSON.stringify(message, null, 2)}`);
                    addToInbox(userId, 'received', message);
                });

                socket.on('joined-chat', (data) => {
                    log('info', `${data.message} (Chat ID: ${data.chatId})`);
                });

                socket.on('left-chat', (data) => {
                    log('info', `${data.message} (Chat ID: ${data.chatId})`);
                });

                socket.on('error', (error) => {
                    const msg = error.event
                        ? `[${error.event}] ${error.message}`
                        : (typeof error === 'object' ? JSON.stringify(error) : error);
                    log('error', msg);
                });
            });

            btnDisconnect.addEventListener('click', () => {
                if (socket) {
                    socket.disconnect();
                    socket = null;
                    currentChatId = null;
                    log('info', 'Disconnected by user');
                    setConnected(false);
                }
            });

            btnJoin.addEventListener('click', () => {
                const id = parseInt(chatId.value);
                if (!id || id < 1) {
                    log('error', 'Please enter a valid Chat ID');
                    return;
                }
                socket.emit('join-chat', id);
                currentChatId = id;
                btnLeave.disabled = false;
                log('info', `Requesting to join chat ${id}...`);
            });

            btnLeave.addEventListener('click', () => {
                const id = parseInt(chatId.value);
                if (!id || id < 1) {
                    log('error', 'Please enter a valid Chat ID');
                    return;
                }
                socket.emit('leave-chat', id);
                log('info', `Requesting to leave chat ${id}...`);
                if (currentChatId === id) {
                    currentChatId = null;
                    btnLeave.disabled = true;
                }
            });

            btnSend.addEventListener('click', () => {
                const id = parseInt(chatId.value);
                const content = messageContent.value.trim();

                if (!id || id < 1) {
                    log('error', 'Please enter a valid Chat ID');
                    return;
                }
                if (!content) {
                    log('error', 'Please enter a message');
                    return;
                }

                socket.emit('send-message', {
                    chatId: id,
                    content: content
                });
                log('sent', `Sent to chat ${id}: ${content}`);
                addToInbox(userId, 'sent', { chatId: id, content: content });
                messageContent.value = '';
                updateCharCount();
            });

            messageContent.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    btnSend.click();
                }
            });

            messageContent.addEventListener('input', updateCharCount);

            btnClear.addEventListener('click', () => {
                messages.innerHTML = '';
            });

            setConnected(false);
        }

        // Initialize both chat clients
        createChatClient('1');
        createChatClient('2');
    </script>
</body>
</html>
